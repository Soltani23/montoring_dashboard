stages:
  - build
  - deploy

variables:
  DOCKER_DRIVER: overlay2
  IMAGE_TAG: "Dashboard"

services:
  - name: docker:dind
    alias: docker

before_script:
  - echo "🔐 Connexion à Docker Registry (Amal Soltani)..."
  - docker login -u "gitlab-ci-token" -p "$CI_JOB_TOKEN" $CI_REGISTRY

build_image:
  stage: build
  image: docker:latest
  script:
    - echo "🚀 Construction de l'image Docker : Dashboard (par Amal Soltani)"
    - docker build -t "$IMAGE_TAG" .
    - echo "📤 Push de l'image sur le registre : $CI_REGISTRY"
    - docker push "$IMAGE_TAG"
  only:
    - main
  tags:
    - docker-runner

deploy_production:
  stage: deploy
  image: alpine:latest
  dependencies:
    - build_image
  before_script:
    - echo "📥 Installation du client SSH"
    - apk add --no-cache openssh-client
    - echo "🔒 Préparation des clés SSH"
    - mkdir -p ~/.ssh
    - echo "$SSH_KNOWN_HOSTS" > ~/.ssh/known_hosts
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
  script:
    - echo "📡 Connexion SSH et déploiement sur le serveur distant par Amal Soltani..."
    - ssh "$DEPLOY_USER@$DEPLOY_SERVER" "
        echo '📥 Récupération de la nouvelle image' && \
        docker pull $IMAGE_TAG && \
        echo '🛑 Arrêt des anciens conteneurs' && \
        cd /path/to/project && \
        docker-compose down && \
        echo '🚀 Lancement des nouveaux conteneurs' && \
        docker-compose up -d
      "
  only:
    - main
  tags:
    - deploy-runner
